<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Simple Foreign Function Interface using S7 and libffi • RSimpleFFI</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Simple Foreign Function Interface using S7 and libffi">
<meta name="description" content="Simple Foreign Function Interface for R using libffi and S7 classes. Supports calling C functions with type conversion and struct handling. Includes standard C types (int8, int16, int32, int64, uint variants), platform types (size_t, bool), floating point types, and complex struct types. Experimental header parsing using tinycc as `C` preprocessor enables automatic generation of R bindings from C header files, simplifying package development for C libraries.">
<meta property="og:description" content="Simple Foreign Function Interface for R using libffi and S7 classes. Supports calling C functions with type conversion and struct handling. Includes standard C types (int8, int16, int32, int64, uint variants), platform types (size_t, bool), floating point types, and complex struct types. Experimental header parsing using tinycc as `C` preprocessor enables automatic generation of R bindings from C header files, simplifying package development for C libraries.">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">RSimpleFFI</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.1.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/sounkou-bioinfo/RSimpleFFI/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="rsimpleffi">RSimpleFFI<a class="anchor" aria-label="anchor" href="#rsimpleffi"></a>
</h1></div>
<!-- badges: start -->

<p>A Simple Foreign Function Interface (FFI) for R using libffi.</p>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>RSimpleFFI lets you call C functions from R using the <a href="https://github.com/libffi/libffi" class="external-link">libffi</a> library. It supports several C types including integers, floats, and platform-specific types. It only needs libffi which is available on most systems and is vendored in this package for unix systems. RSimpleFFI is inspired by the <a href="https://github.com/omegahat/Rffi/" class="external-link">Rffi package</a> by Duncan Temple Lang. It builds on the same structure with S7 classes. As an experimental feature, the package includes automatic R binding generation from C header files using the <a href="https://github.com/tinycc/tinycc" class="external-link"><code>tinycc</code></a> compiler cli for preprocessed c file generation, allowing (attempt) to parse C headers and automatically generate R wrapper functions for easy package development. The <code>tinycc</code> is not used for the in memory compilation facilities but to preprocess the headers given includes and maybe in the future for more reliable C99 compliant parsing and JIT.</p>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>You can install RSimpleFFI from source using the <code>remotes</code> package or via r-universe</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># r-universe</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">'RSimpleFFI'</span>, repos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'https://sounkou-bioinfo.r-universe.dev'</span>, <span class="st">'https://cloud.r-project.org'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># remotes</span></span>
<span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_git</span><span class="op">(</span><span class="st">"sounkou-bioinfo/RSimpleFFI"</span><span class="op">)</span></span></code></pre></div>
<p>on windows, it requires libffi to be installed along with pkg-config : this is always the case with recent <a href="https://cran.r-project.org/bin/windows/Rtools/rtools45/news.html" class="external-link">RTools</a>. On Unix-alikes libffi is always built from source.</p>
</div>
<div class="section level2">
<h2 id="quick-start">Quick Start<a class="anchor" aria-label="anchor" href="#quick-start"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/sounkou-bioinfo/RSimpleFFI" class="external-link">RSimpleFFI</a></span><span class="op">)</span></span>
<span><span class="co"># lib ffi version</span></span>
<span><span class="fu"><a href="reference/libffi_version.html">libffi_version</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "3.5.2"</span></span>
<span><span class="co"># Create FFI types</span></span>
<span><span class="va">int_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">double_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get a C function symbol (using built-in test function compiled with the package)</span></span>
<span><span class="va">add_func</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_symbol.html">ffi_symbol</a></span><span class="op">(</span><span class="st">"test_add_int"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create call interface (CIF)</span></span>
<span><span class="va">cif</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_cif.html">ffi_cif</a></span><span class="op">(</span><span class="va">int_type</span>, <span class="va">int_type</span>, <span class="va">int_type</span><span class="op">)</span>  <span class="co"># return int, takes two ints</span></span>
<span></span>
<span><span class="co"># Call the function</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_call.html">ffi_call</a></span><span class="op">(</span><span class="va">cif</span>, <span class="va">add_func</span>, <span class="fl">15L</span>, <span class="fl">27L</span><span class="op">)</span></span>
<span><span class="va">result</span></span>
<span><span class="co">#&gt; [1] 42</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="type-system">Type System<a class="anchor" aria-label="anchor" href="#type-system"></a>
</h2>
<p>RSimpleFFI supports many C types including integers, floats, and platform-specific types</p>
<div class="section level3">
<h3 id="basic-types">Basic Types<a class="anchor" aria-label="anchor" href="#basic-types"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">void_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_void.html">ffi_void</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">int_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span> </span>
<span><span class="va">double_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">float_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_float.html">ffi_float</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pointer_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_pointer.html">ffi_pointer</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">string_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_string.html">ffi_string</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">int8_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_int8.html">ffi_int8</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">uint8_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_uint8.html">ffi_uint8</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">int16_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_int16.html">ffi_int16</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">uint16_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_uint16.html">ffi_uint16</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">int32_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_int32.html">ffi_int32</a></span><span class="op">(</span><span class="op">)</span> </span>
<span><span class="va">uint32_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_uint32.html">ffi_uint32</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">int64_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_int64.html">ffi_int64</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">uint64_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_uint64.html">ffi_uint64</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">size_t_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_size_t.html">ffi_size_t</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ssize_t_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_ssize_t.html">ffi_ssize_t</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">long_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_long.html">ffi_long</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ulong_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_ulong.html">ffi_ulong</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">longlong_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_longlong.html">ffi_longlong</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ulonglong_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_ulonglong.html">ffi_ulonglong</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">longdouble_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_longdouble.html">ffi_longdouble</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">bool_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_bool.html">ffi_bool</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">wchar_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_wchar_t.html">ffi_wchar_t</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="typed-buffers">Typed Buffers<a class="anchor" aria-label="anchor" href="#typed-buffers"></a>
</h3>
<p>We can allocate typed buffers using <code><a href="reference/alloc.html">ffi_alloc()</a></code> and read/write data using <code><a href="reference/ffi_copy_array.html">ffi_copy_array()</a></code> and <code><a href="reference/ffi_fill_typed_buffer.html">ffi_fill_typed_buffer()</a></code></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Allocate a buffer for 10 integers</span></span>
<span><span class="va">int_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">int_buf</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/alloc.html">ffi_alloc</a></span><span class="op">(</span><span class="va">int_type</span>, <span class="fl">10L</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Read back as R vector (using ffi_copy_array)</span></span>
<span><span class="fu"><a href="reference/ffi_copy_array.html">ffi_copy_array</a></span><span class="op">(</span><span class="va">int_buf</span>, <span class="fl">10L</span>, <span class="va">int_type</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 0 0 0 0 0 0 0 0 0 0</span></span>
<span></span>
<span><span class="co"># You can use ffi_alloc for any builtin type:</span></span>
<span><span class="va">double_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">double_buf</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/alloc.html">ffi_alloc</a></span><span class="op">(</span><span class="va">double_type</span>, <span class="fl">5L</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/ffi_copy_array.html">ffi_copy_array</a></span><span class="op">(</span><span class="va">double_buf</span>, <span class="fl">5L</span>, <span class="va">double_type</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0 0 0 0 0</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="array-types-arraytype">Array Types (ArrayType)<a class="anchor" aria-label="anchor" href="#array-types-arraytype"></a>
</h3>
<p>Array types can be created using <code><a href="reference/ffi_array_type.html">ffi_array_type()</a></code> and used with <code><a href="reference/alloc.html">ffi_alloc()</a></code> and <code><a href="reference/ffi_copy_array_type.html">ffi_copy_array_type()</a></code>. They provide a convenient way to handle fixed-size arrays and passed them to C functions via pointers.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Allocate an array of 4 integers</span></span>
<span><span class="va">int_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">arr_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_array_type.html">ffi_array_type</a></span><span class="op">(</span><span class="va">int_type</span>, <span class="fl">4L</span><span class="op">)</span></span>
<span><span class="va">arr_ptr</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/alloc.html">ffi_alloc</a></span><span class="op">(</span><span class="va">arr_type</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Write values into the buffer using ffi_fill_typed_buffer</span></span>
<span><span class="va">vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10L</span>, <span class="fl">20L</span>, <span class="fl">30L</span>, <span class="fl">40L</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/ffi_fill_typed_buffer.html">ffi_fill_typed_buffer</a></span><span class="op">(</span><span class="va">arr_ptr</span>, <span class="va">vals</span>, <span class="va">int_type</span><span class="op">)</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span></span>
<span><span class="co"># Read back as R vector</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_copy_array_type.html">ffi_copy_array_type</a></span><span class="op">(</span><span class="va">arr_ptr</span>, <span class="va">arr_type</span><span class="op">)</span></span>
<span><span class="va">result</span></span>
<span><span class="co">#&gt; [1] 10 20 30 40</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="struct-types">Struct Types<a class="anchor" aria-label="anchor" href="#struct-types"></a>
</h3>
<p>You can define and use C struct types using <code><a href="reference/ffi_struct.html">ffi_struct()</a></code>, <code><a href="reference/alloc.html">ffi_alloc()</a></code>, <code><a href="reference/ffi_get_field.html">ffi_get_field()</a></code>, and <code><a href="reference/ffi_set_field.html">ffi_set_field()</a></code></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Define a struct type: struct Point { int x; double y; }</span></span>
<span><span class="va">point_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_struct.html">ffi_struct</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">point_type</span></span>
<span><span class="co">#&gt; StructType(fields=[x, y], size=16)</span></span>
<span><span class="co">#&gt; Fields:</span></span>
<span><span class="co">#&gt;   x: FFIType(int, size=4)</span></span>
<span><span class="co">#&gt;   y: FFIType(double, size=8)</span></span>
<span></span>
<span><span class="co"># Allocate a struct instance</span></span>
<span><span class="va">point_ptr</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/alloc.html">ffi_alloc</a></span><span class="op">(</span><span class="va">point_type</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set fields</span></span>
<span><span class="fu"><a href="reference/ffi_set_field.html">ffi_set_field</a></span><span class="op">(</span><span class="va">point_ptr</span>, <span class="st">"x"</span>, <span class="fl">42L</span>, <span class="va">point_type</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/ffi_set_field.html">ffi_set_field</a></span><span class="op">(</span><span class="va">point_ptr</span>, <span class="st">"y"</span>, <span class="fl">3.14</span>, <span class="va">point_type</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get fields</span></span>
<span><span class="va">x_val</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_get_field.html">ffi_get_field</a></span><span class="op">(</span><span class="va">point_ptr</span>, <span class="st">"x"</span>, <span class="va">point_type</span><span class="op">)</span></span>
<span><span class="va">y_val</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_get_field.html">ffi_get_field</a></span><span class="op">(</span><span class="va">point_ptr</span>, <span class="st">"y"</span>, <span class="va">point_type</span><span class="op">)</span></span>
<span><span class="va">x_val</span> </span>
<span><span class="co">#&gt; [1] 42</span></span>
<span><span class="va">y_val</span> </span>
<span><span class="co">#&gt; [1] 3.14</span></span>
<span><span class="co"># You can also use integer field indices (1-based):</span></span>
<span><span class="fu"><a href="reference/ffi_set_field.html">ffi_set_field</a></span><span class="op">(</span><span class="va">point_ptr</span>, <span class="fl">1L</span>, <span class="fl">100L</span>, <span class="va">point_type</span><span class="op">)</span>  </span>
<span><span class="fu"><a href="reference/ffi_get_field.html">ffi_get_field</a></span><span class="op">(</span><span class="va">point_ptr</span>, <span class="fl">1L</span>, <span class="va">point_type</span><span class="op">)</span>       </span>
<span><span class="co">#&gt; [1] 100</span></span></code></pre></div>
<p>structs can be nested</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define inner and outer struct types</span></span>
<span><span class="va">inner_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_struct.html">ffi_struct</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="reference/ffi_int32.html">ffi_int32</a></span><span class="op">(</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">outer_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_struct.html">ffi_struct</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="reference/ffi_int32.html">ffi_int32</a></span><span class="op">(</span><span class="op">)</span>, point <span class="op">=</span> <span class="va">inner_type</span>, label <span class="op">=</span> <span class="fu"><a href="reference/ffi_string.html">ffi_string</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Allocate memory for the outer_type struct</span></span>
<span><span class="va">buf</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_alloc_buffer.html">ffi_alloc_buffer</a></span><span class="op">(</span><span class="fu"><a href="reference/ffi_sizeof.html">ffi_sizeof</a></span><span class="op">(</span><span class="va">outer_type</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set fields in the outer struct</span></span>
<span><span class="fu"><a href="reference/ffi_set_field.html">ffi_set_field</a></span><span class="op">(</span><span class="va">buf</span>, <span class="st">"id"</span>, <span class="fl">42L</span>, <span class="va">outer_type</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/ffi_set_field.html">ffi_set_field</a></span><span class="op">(</span><span class="va">buf</span>, <span class="st">"label"</span>, <span class="st">"example"</span>, <span class="va">outer_type</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Access the nested struct within the parent buffer</span></span>
<span><span class="va">point_ptr</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_get_field.html">ffi_get_field</a></span><span class="op">(</span><span class="va">buf</span>, <span class="st">"point"</span>, <span class="va">outer_type</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/ffi_set_field.html">ffi_set_field</a></span><span class="op">(</span><span class="va">point_ptr</span>, <span class="st">"x"</span>, <span class="fl">10L</span>, <span class="va">inner_type</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/ffi_set_field.html">ffi_set_field</a></span><span class="op">(</span><span class="va">point_ptr</span>, <span class="st">"y"</span>, <span class="fl">3.14</span>, <span class="va">inner_type</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get fields from the outer struct</span></span>
<span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_get_field.html">ffi_get_field</a></span><span class="op">(</span><span class="va">buf</span>, <span class="st">"id"</span>, <span class="va">outer_type</span><span class="op">)</span></span>
<span><span class="va">label</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_get_field.html">ffi_get_field</a></span><span class="op">(</span><span class="va">buf</span>, <span class="st">"label"</span>, <span class="va">outer_type</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get fields from the nested struct</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_get_field.html">ffi_get_field</a></span><span class="op">(</span><span class="va">point_ptr</span>, <span class="st">"x"</span>, <span class="va">inner_type</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_get_field.html">ffi_get_field</a></span><span class="op">(</span><span class="va">point_ptr</span>, <span class="st">"y"</span>, <span class="va">inner_type</span><span class="op">)</span></span>
<span><span class="co"># Show results</span></span>
<span><span class="va">id</span></span>
<span><span class="co">#&gt; [1] 42</span></span>
<span><span class="va">x</span></span>
<span><span class="co">#&gt; [1] 10</span></span>
<span><span class="va">y</span></span>
<span><span class="co">#&gt; [1] 3.14</span></span>
<span><span class="va">label</span>  <span class="co"># string fields are returned directly as character</span></span>
<span><span class="co">#&gt; [1] "example"</span></span></code></pre></div>
<p>You can define more complex structs by adding more fields and using any supported FFI type.</p>
</div>
<div class="section level3">
<h3 id="struct-arrays">Struct Arrays<a class="anchor" aria-label="anchor" href="#struct-arrays"></a>
</h3>
<p>You can allocate contiguous arrays of structs and access elements by index:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define a Point struct</span></span>
<span><span class="va">Point</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_struct.html">ffi_struct</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Allocate an array of 5 Points</span></span>
<span><span class="va">points</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/alloc.html">ffi_alloc</a></span><span class="op">(</span><span class="va">Point</span>, <span class="fl">5L</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set values for each point</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_get_element.html">ffi_get_element</a></span><span class="op">(</span><span class="va">points</span>, <span class="va">i</span>, <span class="va">Point</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="reference/ffi_set_field.html">ffi_set_field</a></span><span class="op">(</span><span class="va">p</span>, <span class="st">"x"</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">i</span> <span class="op">*</span> <span class="fl">10</span><span class="op">)</span>, <span class="va">Point</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="reference/ffi_set_field.html">ffi_set_field</a></span><span class="op">(</span><span class="va">p</span>, <span class="st">"y"</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">i</span> <span class="op">*</span> <span class="fl">20</span><span class="op">)</span>, <span class="va">Point</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Read back values</span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_get_element.html">ffi_get_element</a></span><span class="op">(</span><span class="va">points</span>, <span class="fl">3L</span>, <span class="va">Point</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/ffi_get_field.html">ffi_get_field</a></span><span class="op">(</span><span class="va">p3</span>, <span class="st">"x"</span>, <span class="va">Point</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 30</span></span>
<span><span class="fu"><a href="reference/ffi_get_field.html">ffi_get_field</a></span><span class="op">(</span><span class="va">p3</span>, <span class="st">"y"</span>, <span class="va">Point</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 60</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="field-introspection">Field Introspection<a class="anchor" aria-label="anchor" href="#field-introspection"></a>
</h3>
<p>Use <code><a href="reference/ffi_field_info.html">ffi_field_info()</a></code>, <code><a href="reference/ffi_offsetof.html">ffi_offsetof()</a></code>, and <code><a href="reference/ffi_all_offsets.html">ffi_all_offsets()</a></code> to inspect struct layout:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Struct with alignment padding: int (4) + padding (4) + double (8) = 16 bytes</span></span>
<span><span class="va">Mixed</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_struct.html">ffi_struct</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>, b <span class="op">=</span> <span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/ffi_sizeof.html">ffi_sizeof</a></span><span class="op">(</span><span class="va">Mixed</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 16</span></span>
<span></span>
<span><span class="co"># Get byte offset of a field (like C's offsetof macro)</span></span>
<span><span class="fu"><a href="reference/ffi_offsetof.html">ffi_offsetof</a></span><span class="op">(</span><span class="va">Mixed</span>, <span class="st">"a"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="fu"><a href="reference/ffi_offsetof.html">ffi_offsetof</a></span><span class="op">(</span><span class="va">Mixed</span>, <span class="st">"b"</span><span class="op">)</span>  <span class="co"># offset 8 due to 8-byte alignment</span></span>
<span><span class="co">#&gt; [1] 8</span></span>
<span></span>
<span><span class="co"># Get all offsets at once</span></span>
<span><span class="fu"><a href="reference/ffi_all_offsets.html">ffi_all_offsets</a></span><span class="op">(</span><span class="va">Mixed</span><span class="op">)</span></span>
<span><span class="co">#&gt; a b </span></span>
<span><span class="co">#&gt; 0 8</span></span>
<span></span>
<span><span class="co"># Get detailed field info</span></span>
<span><span class="fu"><a href="reference/ffi_field_info.html">ffi_field_info</a></span><span class="op">(</span><span class="va">Mixed</span>, <span class="st">"b"</span><span class="op">)</span></span>
<span><span class="co">#&gt; FieldInfo('b' type=double, offset=8, size=8)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="struct-packing">Struct Packing<a class="anchor" aria-label="anchor" href="#struct-packing"></a>
</h3>
<p>By default, structs use natural alignment (platform ABI). Use the <code>pack</code> parameter to control alignment, matching C’s <code>#pragma pack(n)</code>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Natural alignment: int (4) + padding (4) + double (8) = 16 bytes</span></span>
<span><span class="va">Natural</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_struct.html">ffi_struct</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>, b <span class="op">=</span> <span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/ffi_sizeof.html">ffi_sizeof</a></span><span class="op">(</span><span class="va">Natural</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 16</span></span>
<span></span>
<span><span class="co"># Packed (no padding): int (4) + double (8) = 12 bytes</span></span>
<span><span class="va">Packed</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_struct.html">ffi_struct</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>, b <span class="op">=</span> <span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span>, pack <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/ffi_sizeof.html">ffi_sizeof</a></span><span class="op">(</span><span class="va">Packed</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 12</span></span>
<span></span>
<span><span class="co"># Field offsets differ between packed and natural</span></span>
<span><span class="fu"><a href="reference/ffi_offsetof.html">ffi_offsetof</a></span><span class="op">(</span><span class="va">Natural</span>, <span class="st">"b"</span><span class="op">)</span>  <span class="co"># 8 (aligned to 8-byte boundary)</span></span>
<span><span class="co">#&gt; [1] 8</span></span>
<span><span class="fu"><a href="reference/ffi_offsetof.html">ffi_offsetof</a></span><span class="op">(</span><span class="va">Packed</span>, <span class="st">"b"</span><span class="op">)</span>   <span class="co"># 4 (immediately after int)</span></span>
<span><span class="co">#&gt; [1] 4</span></span></code></pre></div>
<p>Pack values work like GCC/Clang/MSVC: each field’s alignment is <code>min(natural_alignment, pack)</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># pack=2: fields aligned to at most 2-byte boundaries</span></span>
<span><span class="va">Pack2</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_struct.html">ffi_struct</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>, b <span class="op">=</span> <span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span>, pack <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/ffi_sizeof.html">ffi_sizeof</a></span><span class="op">(</span><span class="va">Pack2</span><span class="op">)</span>   <span class="co"># 12 bytes</span></span>
<span><span class="co">#&gt; [1] 12</span></span>
<span><span class="fu"><a href="reference/ffi_offsetof.html">ffi_offsetof</a></span><span class="op">(</span><span class="va">Pack2</span>, <span class="st">"b"</span><span class="op">)</span>  <span class="co"># 4</span></span>
<span><span class="co">#&gt; [1] 4</span></span>
<span></span>
<span><span class="co"># pack=4: useful for matching 32-bit packed structures</span></span>
<span><span class="va">Pack4</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_struct.html">ffi_struct</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>, b <span class="op">=</span> <span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span>, pack <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/ffi_sizeof.html">ffi_sizeof</a></span><span class="op">(</span><span class="va">Pack4</span><span class="op">)</span>  <span class="co"># 12 bytes</span></span>
<span><span class="co">#&gt; [1] 12</span></span></code></pre></div>
<p>Use <code><a href="reference/ffi_all_offsets.html">ffi_all_offsets()</a></code> to see the complete layout:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compare layouts</span></span>
<span><span class="fu"><a href="reference/ffi_all_offsets.html">ffi_all_offsets</a></span><span class="op">(</span><span class="va">Natural</span><span class="op">)</span>  <span class="co"># a=0, b=8</span></span>
<span><span class="co">#&gt; a b </span></span>
<span><span class="co">#&gt; 0 8</span></span>
<span><span class="fu"><a href="reference/ffi_all_offsets.html">ffi_all_offsets</a></span><span class="op">(</span><span class="va">Packed</span><span class="op">)</span>   <span class="co"># a=0, b=4</span></span>
<span><span class="co">#&gt; a b </span></span>
<span><span class="co">#&gt; 0 4</span></span></code></pre></div>
<div class="section level4">
<h4 id="packed-struct-limitation">Packed Struct Limitation<a class="anchor" aria-label="anchor" href="#packed-struct-limitation"></a>
</h4>
<p>Packed structs cannot be passed by value to C functions (libffi limitation). Use pointers instead.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PackedPoint</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_struct.html">ffi_struct</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="reference/ffi_uint8.html">ffi_uint8</a></span><span class="op">(</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="reference/ffi_int32.html">ffi_int32</a></span><span class="op">(</span><span class="op">)</span>, pack <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="reference/ffi_cif.html">ffi_cif</a></span><span class="op">(</span><span class="va">PackedPoint</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="va">e</span><span class="op">$</span><span class="va">message</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Packed struct 'struct' cannot be passed by value to a C function (libffi limitation). Use a pointer instead.</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="enumerations">Enumerations<a class="anchor" aria-label="anchor" href="#enumerations"></a>
</h3>
<p>Enums map named constants to integer values, useful for flags, status codes, or options:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define an enum type</span></span>
<span><span class="va">Color</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_enum.html">ffi_enum</a></span><span class="op">(</span>RED <span class="op">=</span> <span class="fl">0L</span>, GREEN <span class="op">=</span> <span class="fl">1L</span>, BLUE <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Allocate enum value</span></span>
<span><span class="va">color_ptr</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/alloc.html">ffi_alloc</a></span><span class="op">(</span><span class="va">Color</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert between names and integers</span></span>
<span><span class="fu"><a href="reference/ffi_enum_to_int.html">ffi_enum_to_int</a></span><span class="op">(</span><span class="va">Color</span>, <span class="st">"GREEN"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="fu"><a href="reference/ffi_int_to_enum.html">ffi_int_to_enum</a></span><span class="op">(</span><span class="va">Color</span>, <span class="fl">1L</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "GREEN"</span></span>
<span></span>
<span><span class="co"># Use enums in structs</span></span>
<span><span class="va">Pixel</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_struct.html">ffi_struct</a></span><span class="op">(</span></span>
<span>  color <span class="op">=</span> <span class="va">Color</span>,</span>
<span>  intensity <span class="op">=</span> <span class="fu"><a href="reference/ffi_uint8.html">ffi_uint8</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">pixel</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/alloc.html">ffi_alloc</a></span><span class="op">(</span><span class="va">Pixel</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/ffi_set_field.html">ffi_set_field</a></span><span class="op">(</span><span class="va">pixel</span>, <span class="st">"color"</span>, <span class="fu"><a href="reference/ffi_enum_to_int.html">ffi_enum_to_int</a></span><span class="op">(</span><span class="va">Color</span>, <span class="st">"RED"</span><span class="op">)</span>, <span class="va">Pixel</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/ffi_set_field.html">ffi_set_field</a></span><span class="op">(</span><span class="va">pixel</span>, <span class="st">"intensity"</span>, <span class="fl">255L</span>, <span class="va">Pixel</span><span class="op">)</span></span>
<span></span>
<span><span class="va">color_val</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_get_field.html">ffi_get_field</a></span><span class="op">(</span><span class="va">pixel</span>, <span class="st">"color"</span>, <span class="va">Pixel</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/ffi_int_to_enum.html">ffi_int_to_enum</a></span><span class="op">(</span><span class="va">Color</span>, <span class="va">color_val</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "RED"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="unions">Unions<a class="anchor" aria-label="anchor" href="#unions"></a>
</h3>
<p>Unions allow multiple fields to share the same memory location, useful for variant types or memory-efficient data structures:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define a union (all fields share the same memory)</span></span>
<span><span class="va">Value</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_union.html">ffi_union</a></span><span class="op">(</span></span>
<span>  as_int <span class="op">=</span> <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  as_float <span class="op">=</span> <span class="fu"><a href="reference/ffi_float.html">ffi_float</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  as_bytes <span class="op">=</span> <span class="fu"><a href="reference/ffi_array_type.html">ffi_array_type</a></span><span class="op">(</span><span class="fu"><a href="reference/ffi_uint8.html">ffi_uint8</a></span><span class="op">(</span><span class="op">)</span>, <span class="fl">4L</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Allocate union</span></span>
<span><span class="va">val</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/alloc.html">ffi_alloc</a></span><span class="op">(</span><span class="va">Value</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Write as integer</span></span>
<span><span class="fu"><a href="reference/ffi_set_field.html">ffi_set_field</a></span><span class="op">(</span><span class="va">val</span>, <span class="st">"as_int"</span>, <span class="fl">0x41424344L</span>, <span class="va">Value</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Read back as integer</span></span>
<span><span class="fu"><a href="reference/ffi_get_field.html">ffi_get_field</a></span><span class="op">(</span><span class="va">val</span>, <span class="st">"as_int"</span>, <span class="va">Value</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1094861636</span></span>
<span></span>
<span><span class="co"># Read the same memory as float (reinterprets the bits)</span></span>
<span><span class="fu"><a href="reference/ffi_get_field.html">ffi_get_field</a></span><span class="op">(</span><span class="va">val</span>, <span class="st">"as_float"</span>, <span class="va">Value</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 12.14142</span></span>
<span></span>
<span><span class="co"># Tagged union example (union + tag field)</span></span>
<span><span class="va">TaggedValue</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_struct.html">ffi_struct</a></span><span class="op">(</span></span>
<span>  tag <span class="op">=</span> <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>,  <span class="co"># 0=int, 1=float</span></span>
<span>  data <span class="op">=</span> <span class="va">Value</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">tagged</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/alloc.html">ffi_alloc</a></span><span class="op">(</span><span class="va">TaggedValue</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/ffi_set_field.html">ffi_set_field</a></span><span class="op">(</span><span class="va">tagged</span>, <span class="st">"tag"</span>, <span class="fl">1L</span>, <span class="va">TaggedValue</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Access nested union</span></span>
<span><span class="va">data_ptr</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_get_field.html">ffi_get_field</a></span><span class="op">(</span><span class="va">tagged</span>, <span class="st">"data"</span>, <span class="va">TaggedValue</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/ffi_set_field.html">ffi_set_field</a></span><span class="op">(</span><span class="va">data_ptr</span>, <span class="st">"as_float"</span>, <span class="fl">3.14</span>, <span class="va">Value</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/ffi_get_field.html">ffi_get_field</a></span><span class="op">(</span><span class="va">data_ptr</span>, <span class="st">"as_float"</span>, <span class="va">Value</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3.14</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="function-calling">Function Calling<a class="anchor" aria-label="anchor" href="#function-calling"></a>
</h2>
<div class="section level3">
<h3 id="basic-function-calls">Basic Function Calls<a class="anchor" aria-label="anchor" href="#basic-function-calls"></a>
</h3>
<p>The package comes with some built-in C test functions for testing, they are defined in <a href="src/test_functions.c">src/test_functions.c</a></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">void_func</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_symbol.html">ffi_symbol</a></span><span class="op">(</span><span class="st">"test_void_function"</span><span class="op">)</span></span>
<span><span class="va">void_cif</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_cif.html">ffi_cif</a></span><span class="op">(</span><span class="va">void_type</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/ffi_call.html">ffi_call</a></span><span class="op">(</span><span class="va">void_cif</span>, <span class="va">void_func</span><span class="op">)</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span></span>
<span><span class="va">factorial_func</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_symbol.html">ffi_symbol</a></span><span class="op">(</span><span class="st">"test_factorial"</span><span class="op">)</span></span>
<span><span class="va">factorial_cif</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_cif.html">ffi_cif</a></span><span class="op">(</span><span class="va">int_type</span>, <span class="va">int_type</span><span class="op">)</span></span>
<span><span class="va">factorial_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_call.html">ffi_call</a></span><span class="op">(</span><span class="va">factorial_cif</span>, <span class="va">factorial_func</span>, <span class="fl">5L</span><span class="op">)</span></span>
<span><span class="va">factorial_result</span></span>
<span><span class="co">#&gt; [1] 120</span></span></code></pre></div>
<div class="section level4">
<h4 id="testing-integer-types">Testing Integer Types<a class="anchor" aria-label="anchor" href="#testing-integer-types"></a>
</h4>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># test_int8_func: returns input + 1</span></span>
<span><span class="va">int8_func</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_symbol.html">ffi_symbol</a></span><span class="op">(</span><span class="st">"test_int8_func"</span><span class="op">)</span></span>
<span><span class="va">int8_cif</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_cif.html">ffi_cif</a></span><span class="op">(</span><span class="va">int8_type</span>, <span class="va">int8_type</span><span class="op">)</span></span>
<span><span class="va">int8_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_call.html">ffi_call</a></span><span class="op">(</span><span class="va">int8_cif</span>, <span class="va">int8_func</span>, <span class="fl">42L</span><span class="op">)</span></span>
<span><span class="va">int8_result</span>  <span class="co"># 42 + 1 = 43</span></span>
<span><span class="co">#&gt; [1] 43</span></span>
<span></span>
<span><span class="co"># test_uint32_func: returns input * 3</span></span>
<span><span class="va">uint32_func</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_symbol.html">ffi_symbol</a></span><span class="op">(</span><span class="st">"test_uint32_func"</span><span class="op">)</span> </span>
<span><span class="va">uint32_cif</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_cif.html">ffi_cif</a></span><span class="op">(</span><span class="va">uint32_type</span>, <span class="va">uint32_type</span><span class="op">)</span></span>
<span><span class="va">uint32_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_call.html">ffi_call</a></span><span class="op">(</span><span class="va">uint32_cif</span>, <span class="va">uint32_func</span>, <span class="fl">123L</span><span class="op">)</span></span>
<span><span class="va">uint32_result</span>  <span class="co"># 123 * 3 = 369</span></span>
<span><span class="co">#&gt; [1] 369</span></span>
<span></span>
<span><span class="co"># test_int64_func: returns input * 4</span></span>
<span><span class="va">int64_func</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_symbol.html">ffi_symbol</a></span><span class="op">(</span><span class="st">"test_int64_func"</span><span class="op">)</span></span>
<span><span class="va">int64_cif</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_cif.html">ffi_cif</a></span><span class="op">(</span><span class="va">int64_type</span>, <span class="va">int64_type</span><span class="op">)</span></span>
<span><span class="va">int64_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_call.html">ffi_call</a></span><span class="op">(</span><span class="va">int64_cif</span>, <span class="va">int64_func</span>, <span class="fl">999L</span><span class="op">)</span></span>
<span><span class="va">int64_result</span>  <span class="co"># 999 * 4 = 3996</span></span>
<span><span class="co">#&gt; [1] 3996</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="floating-point-types">Floating-Point Types<a class="anchor" aria-label="anchor" href="#floating-point-types"></a>
</h4>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">add_func</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_symbol.html">ffi_symbol</a></span><span class="op">(</span><span class="st">"test_add_int"</span><span class="op">)</span></span>
<span><span class="va">add_cif</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_cif.html">ffi_cif</a></span><span class="op">(</span><span class="va">int_type</span>, <span class="va">int_type</span>, <span class="va">int_type</span><span class="op">)</span></span>
<span><span class="va">int_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_call.html">ffi_call</a></span><span class="op">(</span><span class="va">add_cif</span>, <span class="va">add_func</span>, <span class="fl">10L</span>, <span class="fl">5L</span><span class="op">)</span></span>
<span><span class="va">int_result</span></span>
<span><span class="co">#&gt; [1] 15</span></span>
<span></span>
<span><span class="va">double_func</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_symbol.html">ffi_symbol</a></span><span class="op">(</span><span class="st">"test_add_double"</span><span class="op">)</span></span>
<span><span class="va">double_cif</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_cif.html">ffi_cif</a></span><span class="op">(</span><span class="va">double_type</span>, <span class="va">double_type</span>, <span class="va">double_type</span><span class="op">)</span></span>
<span><span class="va">double_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_call.html">ffi_call</a></span><span class="op">(</span><span class="va">double_cif</span>, <span class="va">double_func</span>, <span class="fl">3.14</span>, <span class="fl">2.86</span><span class="op">)</span></span>
<span><span class="va">double_result</span></span>
<span><span class="co">#&gt; [1] 6</span></span>
<span></span>
<span><span class="va">float_func</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_symbol.html">ffi_symbol</a></span><span class="op">(</span><span class="st">"test_add_float"</span><span class="op">)</span></span>
<span><span class="va">float_cif</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_cif.html">ffi_cif</a></span><span class="op">(</span><span class="va">float_type</span>, <span class="va">float_type</span>, <span class="va">float_type</span><span class="op">)</span></span>
<span><span class="va">float_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_call.html">ffi_call</a></span><span class="op">(</span><span class="va">float_cif</span>, <span class="va">float_func</span>, <span class="fl">1.5</span>, <span class="fl">2.5</span><span class="op">)</span></span>
<span><span class="va">float_result</span></span>
<span><span class="co">#&gt; [1] 4</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="string-output-example">String output example<a class="anchor" aria-label="anchor" href="#string-output-example"></a>
</h4>
<p>This calls a C function that returns a string (const char*). With <code><a href="reference/ffi_string.html">ffi_string()</a></code> type, strings are returned directly as R character vectors.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">string_func</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_symbol.html">ffi_symbol</a></span><span class="op">(</span><span class="st">"test_return_string"</span><span class="op">)</span></span>
<span><span class="va">string_cif</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_cif.html">ffi_cif</a></span><span class="op">(</span><span class="va">string_type</span><span class="op">)</span></span>
<span><span class="va">string_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_call.html">ffi_call</a></span><span class="op">(</span><span class="va">string_cif</span>, <span class="va">string_func</span><span class="op">)</span></span>
<span><span class="va">string_result</span>  <span class="co"># returned directly as character</span></span>
<span><span class="co">#&gt; [1] "Hello from C!"</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="struct-types-1">Struct Types<a class="anchor" aria-label="anchor" href="#struct-types-1"></a>
</h4>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define struct type: struct Point { int x; double y; }</span></span>
<span><span class="va">point_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_struct.html">ffi_struct</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Allocate and set fields</span></span>
<span><span class="va">point_ptr</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/alloc.html">ffi_alloc</a></span><span class="op">(</span><span class="va">point_type</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/ffi_set_field.html">ffi_set_field</a></span><span class="op">(</span><span class="va">point_ptr</span>, <span class="st">"x"</span>, <span class="fl">42L</span>, <span class="va">point_type</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/ffi_set_field.html">ffi_set_field</a></span><span class="op">(</span><span class="va">point_ptr</span>, <span class="st">"y"</span>, <span class="fl">3.14</span>, <span class="va">point_type</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Call the built-in C function: int test_get_point_x(Point2D* point)</span></span>
<span><span class="va">get_point_x_func</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_symbol.html">ffi_symbol</a></span><span class="op">(</span><span class="st">"test_get_point_x"</span><span class="op">)</span></span>
<span><span class="va">get_point_x_cif</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_cif.html">ffi_cif</a></span><span class="op">(</span><span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_pointer.html">ffi_pointer</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">result_x</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_call.html">ffi_call</a></span><span class="op">(</span><span class="va">get_point_x_cif</span>, <span class="va">get_point_x_func</span>, <span class="va">point_ptr</span><span class="op">)</span></span>
<span><span class="va">result_x</span>  </span>
<span><span class="co">#&gt; [1] 42</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="type-conversions">Type Conversions<a class="anchor" aria-label="anchor" href="#type-conversions"></a>
</h4>
<p>RSimpleFFI converts between R and C types following C99 semantics. Doubles are truncated to integers, overflow uses modular arithmetic, and negative values convert to unsigned types via two’s complement (e.g., <code>-1L</code> -&gt; <code>uint8</code> = 255). Large integers (64-bit) return as doubles and may lose precision beyond 2^53.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Integer truncation: 5.7 -&gt; 5</span></span>
<span><span class="va">int_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">add_fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_function.html">ffi_function</a></span><span class="op">(</span><span class="st">"test_add_int"</span>, <span class="va">int_type</span>, <span class="va">int_type</span>, <span class="va">int_type</span><span class="op">)</span></span>
<span><span class="fu">add_fn</span><span class="op">(</span><span class="fl">5.7</span>, <span class="fl">3.2</span><span class="op">)</span>  <span class="co"># 5 + 3 = 8</span></span>
<span><span class="co">#&gt; [1] 8</span></span>
<span></span>
<span><span class="co"># Signed overflow wraps (int8 range is -128 to 127)</span></span>
<span><span class="va">int8_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_int8.html">ffi_int8</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">int8_fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_function.html">ffi_function</a></span><span class="op">(</span><span class="st">"test_int8_func"</span>, <span class="va">int8_type</span>, <span class="va">int8_type</span><span class="op">)</span></span>
<span><span class="fu">int8_fn</span><span class="op">(</span><span class="fl">127L</span><span class="op">)</span>  <span class="co"># 127 + 1 wraps to -128</span></span>
<span><span class="co">#&gt; [1] -128</span></span>
<span></span>
<span><span class="co"># Unsigned modular arithmetic</span></span>
<span><span class="va">uint8_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_uint8.html">ffi_uint8</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">uint8_fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_function.html">ffi_function</a></span><span class="op">(</span><span class="st">"test_uint8_func"</span>, <span class="va">uint8_type</span>, <span class="va">uint8_type</span><span class="op">)</span></span>
<span><span class="fu">uint8_fn</span><span class="op">(</span><span class="op">-</span><span class="fl">1L</span><span class="op">)</span>  <span class="co"># -1 as uint8 = 255, then +1 wraps to 0</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span></span>
<span><span class="co"># Bool conversion</span></span>
<span><span class="va">bool_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_bool.html">ffi_bool</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">bool_fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_function.html">ffi_function</a></span><span class="op">(</span><span class="st">"test_bool_func"</span>, <span class="va">bool_type</span>, <span class="va">bool_type</span><span class="op">)</span></span>
<span><span class="fu">bool_fn</span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span>   <span class="co"># !TRUE = FALSE</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="fu">bool_fn</span><span class="op">(</span><span class="fl">42L</span><span class="op">)</span>    <span class="co"># 42 != 0 -&gt; TRUE, !TRUE = FALSE</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="na-handling">NA Handling<a class="anchor" aria-label="anchor" href="#na-handling"></a>
</h4>
<p>By default, NA values in arguments raise an error to prevent silent data corruption (<code>NA_integer_</code> becomes <code>INT_MIN</code>, <code>NA_real_</code> becomes a NaN that C doesn’t recognize as missing).</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># NA values cause errors by default</span></span>
<span><span class="va">add_fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_function.html">ffi_function</a></span><span class="op">(</span><span class="st">"test_add_int"</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">add_fn</span><span class="op">(</span><span class="cn">NA_integer_</span>, <span class="fl">5L</span><span class="op">)</span>  <span class="co"># Error: NA values in arguments</span></span>
<span><span class="co">#&gt; Error: NA value not allowed in argument 1. Use na_check=FALSE to allow (at your own risk).</span></span></code></pre></div>
<p>If you know what you’re doing and want to pass NA values (e.g., when working with sentinel values), you can disable the check:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Disable NA check with na_check = FALSE</span></span>
<span><span class="va">add_fn_unsafe</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_function.html">ffi_function</a></span><span class="op">(</span><span class="st">"test_add_int"</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>, na_check <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu">add_fn_unsafe</span><span class="op">(</span><span class="cn">NA_integer_</span>, <span class="fl">5L</span><span class="op">)</span>  <span class="co"># Passes NA as INT_MIN</span></span>
<span><span class="co">#&gt; [1] -2147483643</span></span>
<span></span>
<span><span class="co"># You can also use na_check in ffi_call and dll_ffi_symbol</span></span>
<span><span class="va">cif</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_cif.html">ffi_cif</a></span><span class="op">(</span><span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sym</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_symbol.html">ffi_symbol</a></span><span class="op">(</span><span class="st">"test_add_int"</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/ffi_call.html">ffi_call</a></span><span class="op">(</span><span class="va">cif</span>, <span class="va">sym</span>, <span class="cn">NA_integer_</span>, <span class="fl">5L</span>, na_check <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -2147483643</span></span></code></pre></div>
<p>Note that <code>NaN</code> (Not a Number) values are allowed through because they have well-defined IEEE 754 semantics that C understands:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># NaN passes through - it has IEEE semantics</span></span>
<span><span class="va">double_fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_function.html">ffi_function</a></span><span class="op">(</span><span class="st">"test_add_double"</span>, <span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">double_fn</span><span class="op">(</span><span class="cn">NaN</span>, <span class="fl">5.0</span><span class="op">)</span>  <span class="co"># NaN + 5 = NaN</span></span>
<span><span class="co">#&gt; [1] NaN</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="closures-r-callbacks-for-c">Closures (R callbacks for C)<a class="anchor" aria-label="anchor" href="#closures-r-callbacks-for-c"></a>
</h3>
<p>The closure API lets you wrap R functions as C callbacks. This is useful when C code expects a function pointer (e.g., qsort comparator, event handlers).</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create an R function to use as callback</span></span>
<span><span class="va">add_ten</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span> <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"adding "</span> , <span class="va">x</span>, <span class="st">" to 10"</span><span class="op">)</span><span class="op">)</span></span>
<span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">x</span> <span class="op">+</span> <span class="fl">10L</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Wrap it: int (*callback)(int)</span></span>
<span><span class="va">closure</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_closure.html">ffi_closure</a></span><span class="op">(</span><span class="va">add_ten</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get the function pointer to pass to C</span></span>
<span><span class="va">callback_ptr</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_closure_pointer.html">ffi_closure_pointer</a></span><span class="op">(</span><span class="va">closure</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Call C function that accepts a callback: test_callback(func, value)</span></span>
<span><span class="va">test_callback_fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_function.html">ffi_function</a></span><span class="op">(</span></span>
<span> <span class="st">"test_callback"</span>,</span>
<span> <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span> <span class="fu"><a href="reference/ffi_pointer.html">ffi_pointer</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span> <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">test_callback_fn</span><span class="op">(</span><span class="va">callback_ptr</span>, <span class="fl">5L</span><span class="op">)</span>  <span class="co"># 5 + 10 = 15</span></span>
<span><span class="co">#&gt; [1] "adding 5 to 10"</span></span>
<span><span class="co">#&gt; [1] 15</span></span></code></pre></div>
<p>Closures work with any signature:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># double (*transform)(double)</span></span>
<span><span class="va">square</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">*</span> <span class="va">x</span></span>
<span><span class="va">square_closure</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_closure.html">ffi_closure</a></span><span class="op">(</span><span class="va">square</span>, <span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">test_double_callback_fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_function.html">ffi_function</a></span><span class="op">(</span></span>
<span> <span class="st">"test_double_callback"</span>,</span>
<span> <span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span> <span class="fu"><a href="reference/ffi_pointer.html">ffi_pointer</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span> <span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">test_double_callback_fn</span><span class="op">(</span><span class="fu"><a href="reference/ffi_closure_pointer.html">ffi_closure_pointer</a></span><span class="op">(</span><span class="va">square_closure</span><span class="op">)</span>, <span class="fl">4.0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 16</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="call-system-libraries-functions-or-external-shared-libraries">Call system libraries functions or external shared libraries<a class="anchor" aria-label="anchor" href="#call-system-libraries-functions-or-external-shared-libraries"></a>
</h3>
<p>You can load external shared libraries at runtime using RSimpleFFI’s <code><a href="reference/dynamic_library_management.html">dll_load()</a></code> and <code><a href="reference/dll_ffi_symbol.html">dll_ffi_symbol()</a></code> functions. These are wrappers around R’s native <code><a href="https://rdrr.io/r/base/dynload.html" class="external-link">dyn.load()</a></code> facilities that search for shared libraries in system paths when required.</p>
<div class="section level4">
<h4 id="search-so-files-in-system-paths">Search so files in system paths<a class="anchor" aria-label="anchor" href="#search-so-files-in-system-paths"></a>
</h4>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example: call the C standard library rand() function</span></span>
<span><span class="va">libc_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/dynamic_library_management.html">dll_load_system</a></span><span class="op">(</span><span class="st">"libc.so.6"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading system library from: /usr/lib/x86_64-linux-gnu/libc.so.6</span></span>
<span><span class="va">rand_func</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/dll_ffi_symbol.html">dll_ffi_symbol</a></span><span class="op">(</span><span class="st">"rand"</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rand_value</span> <span class="op">&lt;-</span> <span class="fu">rand_func</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">rand_value</span></span>
<span><span class="co">#&gt; [1] 59431030</span></span>
<span><span class="va">rand_value</span> <span class="op">&lt;-</span> <span class="fu">rand_func</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">rand_value</span></span>
<span><span class="co">#&gt; [1] 58914753</span></span>
<span><span class="fu"><a href="reference/dynamic_library_management.html">dll_unload</a></span><span class="op">(</span><span class="va">libc_path</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="explicitly-load-shared-libraries">Explicitly load shared libraries<a class="anchor" aria-label="anchor" href="#explicitly-load-shared-libraries"></a>
</h4>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Find the libc shared object (libc is always present)</span></span>
<span><span class="va">so_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="st">"/lib/x86_64-linux-gnu"</span>, pattern <span class="op">=</span> <span class="st">"^libc[.]so[.]6$"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">so_files</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"libc.so.6 not found"</span><span class="op">)</span></span>
<span><span class="va">lib_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/dynamic_library_management.html">dll_load</a></span><span class="op">(</span><span class="va">so_files</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Allocate a buffer of 8 bytes</span></span>
<span><span class="va">raw_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_raw.html">ffi_raw</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">buf_ptr</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/alloc.html">ffi_alloc</a></span><span class="op">(</span><span class="va">raw_type</span>, <span class="fl">8L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html" class="external-link">rawToChar</a></span><span class="op">(</span><span class="fu"><a href="reference/ffi_copy_array.html">ffi_copy_array</a></span><span class="op">(</span><span class="va">buf_ptr</span>, <span class="fl">8L</span>, <span class="va">raw_type</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] ""</span></span>
<span><span class="co"># Get memset from libc: void *memset(void *s, int c, size_t n)</span></span>
<span><span class="va">memset_fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/dll_ffi_symbol.html">dll_ffi_symbol</a></span><span class="op">(</span><span class="st">"memset"</span>, <span class="fu"><a href="reference/ffi_pointer.html">ffi_pointer</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_pointer.html">ffi_pointer</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_size_t.html">ffi_size_t</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fill the buffer with ASCII 'A' (0x41)</span></span>
<span><span class="fu">memset_fn</span><span class="op">(</span><span class="va">buf_ptr</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fl">0x41</span><span class="op">)</span>, <span class="fl">8L</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;pointer: 0x5585a3891940&gt;</span></span>
<span></span>
<span><span class="co"># Read back the buffer and print as string</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html" class="external-link">rawToChar</a></span><span class="op">(</span><span class="fu"><a href="reference/ffi_copy_array.html">ffi_copy_array</a></span><span class="op">(</span><span class="va">buf_ptr</span>, <span class="fl">8L</span>, <span class="va">raw_type</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "AAAAAAAA"</span></span>
<span></span>
<span><span class="fu"><a href="reference/pointer_to_string.html">pointer_to_string</a></span><span class="op">(</span><span class="va">buf_ptr</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "AAAAAAAA"</span></span>
<span></span>
<span><span class="fu"><a href="reference/dynamic_library_management.html">dll_unload</a></span><span class="op">(</span><span class="va">lib_path</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="compile-and-load-c-code">Compile and Load C Code<a class="anchor" aria-label="anchor" href="#compile-and-load-c-code"></a>
</h3>
<p>The package provides facilities to load C code on the fly. The compiler uses R CMD SHLIB under the hood</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">c_code</span> <span class="op">&lt;-</span> <span class="st">'</span></span>
<span><span class="st">int add_numbers(int a, int b) {</span></span>
<span><span class="st">    return a + b;</span></span>
<span><span class="st">}</span></span>
<span><span class="st">'</span></span>
<span></span>
<span><span class="va">lib_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/dynamic_library_management.html">dll_compile_and_load</a></span><span class="op">(</span><span class="va">c_code</span>, <span class="st">"example_lib"</span><span class="op">)</span></span>
<span><span class="va">int_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">add_fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/dll_ffi_symbol.html">dll_ffi_symbol</a></span><span class="op">(</span><span class="st">"add_numbers"</span>, <span class="va">int_t</span>, <span class="va">int_t</span>, <span class="va">int_t</span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">add_fn</span><span class="op">(</span><span class="fl">10L</span>, <span class="fl">5L</span><span class="op">)</span></span>
<span><span class="va">result</span></span>
<span><span class="co">#&gt; [1] 15</span></span>
<span></span>
<span><span class="fu"><a href="reference/dynamic_library_management.html">dll_unload</a></span><span class="op">(</span><span class="va">lib_path</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">math_code</span> <span class="op">&lt;-</span> <span class="st">'</span></span>
<span><span class="st">#include &lt;math.h&gt;</span></span>
<span><span class="st">double compute_distance(double x1, double y1, double x2, double y2) {</span></span>
<span><span class="st">    double dx = x2 - x1;</span></span>
<span><span class="st">    double dy = y2 - y1;</span></span>
<span><span class="st">    return sqrt(dx*dx + dy*dy);</span></span>
<span><span class="st">}</span></span>
<span><span class="st">'</span></span>
<span></span>
<span><span class="va">lib_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/dynamic_library_management.html">dll_compile_and_load</a></span><span class="op">(</span><span class="va">math_code</span>, <span class="st">"math_lib"</span>, libs <span class="op">=</span> <span class="st">"m"</span><span class="op">)</span></span>
<span><span class="va">double_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">distance_fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/dll_ffi_symbol.html">dll_ffi_symbol</a></span><span class="op">(</span><span class="st">"compute_distance"</span>, <span class="va">double_t</span>, <span class="va">double_t</span>, <span class="va">double_t</span>, <span class="va">double_t</span>, <span class="va">double_t</span><span class="op">)</span></span>
<span><span class="va">dist</span> <span class="op">&lt;-</span> <span class="fu">distance_fn</span><span class="op">(</span><span class="fl">0.0</span>, <span class="fl">0.0</span>, <span class="fl">3.0</span>, <span class="fl">4.0</span><span class="op">)</span></span>
<span><span class="va">dist</span></span>
<span><span class="co">#&gt; [1] 5</span></span>
<span></span>
<span><span class="fu"><a href="reference/dynamic_library_management.html">dll_unload</a></span><span class="op">(</span><span class="va">lib_path</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="benchmarking">Benchmarking<a class="anchor" aria-label="anchor" href="#benchmarking"></a>
</h2>
<p>We run some benchmarks to estimate the performance of FFI calls (i.e the overhead of calling C functions from R using RSimpleFFI) compared to native R C built-in functions.</p>
<div class="section level3">
<h3 id="r-builtin-c-functions">R builtin C functions<a class="anchor" aria-label="anchor" href="#r-builtin-c-functions"></a>
</h3>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">10000</span></span>
<span><span class="va">x_vec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">x_ptr</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/alloc.html">ffi_alloc</a></span><span class="op">(</span><span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">n</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/ffi_fill_typed_buffer.html">ffi_fill_typed_buffer</a></span><span class="op">(</span><span class="va">x_ptr</span>, <span class="va">x_vec</span>, <span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="va">out_ptr</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/alloc.html">ffi_alloc</a></span><span class="op">(</span><span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">n</span><span class="op">)</span></span>
<span></span>
<span><span class="va">math_code</span> <span class="op">&lt;-</span> <span class="st">'</span></span>
<span><span class="st">#include &lt;math.h&gt;</span></span>
<span><span class="st">void vec_sqrt(const double* x, double* out, int n) {</span></span>
<span><span class="st">    for (int i = 0; i &lt; n; ++i) out[i] = sqrt(x[i]);</span></span>
<span><span class="st">}</span></span>
<span><span class="st">'</span></span>
<span><span class="va">lib_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/dynamic_library_management.html">dll_compile_and_load</a></span><span class="op">(</span><span class="va">math_code</span>, <span class="st">"bench_vec"</span>, libs <span class="op">=</span> <span class="st">"m"</span>, cflags <span class="op">=</span> <span class="st">"-O3"</span><span class="op">)</span></span>
<span><span class="va">vec_sqrt_func</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/dll_ffi_symbol.html">dll_ffi_symbol</a></span><span class="op">(</span><span class="st">"vec_sqrt"</span>, <span class="fu"><a href="reference/ffi_void.html">ffi_void</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_pointer.html">ffi_pointer</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_pointer.html">ffi_pointer</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">benchmark_result</span> <span class="op">&lt;-</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span></span>
<span>  native_r <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">x_vec</span><span class="op">)</span>,</span>
<span>  ffi_call <span class="op">=</span> <span class="op">{</span> <span class="fu">vec_sqrt_func</span><span class="op">(</span><span class="va">x_ptr</span>, <span class="va">out_ptr</span>, <span class="va">n</span><span class="op">)</span>; <span class="fu"><a href="reference/ffi_copy_array.html">ffi_copy_array</a></span><span class="op">(</span><span class="va">out_ptr</span>, <span class="va">n</span>, <span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">}</span>,</span>
<span>  check <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  iterations <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="op">)</span></span>
<span><span class="va">benchmark_result</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 6</span></span>
<span><span class="co">#&gt;   expression      min   median `itr/sec` mem_alloc `gc/sec`</span></span>
<span><span class="co">#&gt;   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 native_r     12.9µs   29.2µs    34267.    78.2KB        0</span></span>
<span><span class="co">#&gt; 2 ffi_call     92.9µs     97µs    10012.    78.7KB        0</span></span>
<span><span class="fu"><a href="reference/dynamic_library_management.html">dll_unload</a></span><span class="op">(</span><span class="va">lib_path</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="interpreted-r-code">Interpreted R Code<a class="anchor" aria-label="anchor" href="#interpreted-r-code"></a>
</h3>
<p>We compare a pure C convolution (via FFI) to a simple R implementation.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Slow R convolution</span></span>
<span><span class="va">slow_convolve</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">double</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">ab</span><span class="op">[</span><span class="va">i</span> <span class="op">+</span> <span class="va">j</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">ab</span><span class="op">[</span><span class="va">i</span> <span class="op">+</span> <span class="va">j</span> <span class="op">-</span> <span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">a</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="va">b</span><span class="op">[</span><span class="va">j</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">ab</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># C code for convolution (matches R)</span></span>
<span><span class="va">conv_code</span> <span class="op">&lt;-</span> <span class="st">'</span></span>
<span><span class="st">#include &lt;stdio.h&gt;</span></span>
<span><span class="st">void c_convolve(const double* signal, int n_signal, const double* kernel, int n_kernel, double* out) {</span></span>
<span><span class="st">  int n_out = n_signal + n_kernel - 1;</span></span>
<span><span class="st">  for (int i = 0; i &lt; n_out; ++i) {</span></span>
<span><span class="st">    out[i] = 0.0;</span></span>
<span><span class="st">    for (int j = 0; j &lt; n_kernel; ++j) {</span></span>
<span><span class="st">      int k = i - j;</span></span>
<span><span class="st">      if (k &gt;= 0 &amp;&amp; k &lt; n_signal) {</span></span>
<span><span class="st">        //printf("signal[%d]=%f, kernel[%d]=%f\\n", k, signal[k], j, kernel[j]);</span></span>
<span><span class="st">        out[i] += signal[k] * kernel[j];</span></span>
<span><span class="st">      }</span></span>
<span><span class="st">    }</span></span>
<span><span class="st">  }</span></span>
<span><span class="st">}</span></span>
<span><span class="st">'</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1995</span><span class="op">)</span></span>
<span><span class="va">signal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">10000</span><span class="op">)</span></span>
<span><span class="va">kernel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.5</span>, <span class="fl">0.3</span><span class="op">)</span></span>
<span><span class="va">n_signal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">signal</span><span class="op">)</span></span>
<span><span class="va">n_kernel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">kernel</span><span class="op">)</span></span>
<span><span class="va">n_out</span> <span class="op">&lt;-</span> <span class="va">n_signal</span> <span class="op">+</span> <span class="va">n_kernel</span> <span class="op">-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="co"># Allocate buffers for FFI</span></span>
<span><span class="va">signal_ptr</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/alloc.html">ffi_alloc</a></span><span class="op">(</span><span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">n_signal</span><span class="op">)</span></span>
<span><span class="va">kernel_ptr</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/alloc.html">ffi_alloc</a></span><span class="op">(</span><span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">n_kernel</span><span class="op">)</span></span>
<span><span class="va">out_ptr</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/alloc.html">ffi_alloc</a></span><span class="op">(</span><span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">n_out</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fill buffers</span></span>
<span><span class="fu"><a href="reference/ffi_fill_typed_buffer.html">ffi_fill_typed_buffer</a></span><span class="op">(</span><span class="va">signal_ptr</span>, <span class="va">signal</span>, <span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="fu"><a href="reference/ffi_copy_array.html">ffi_copy_array</a></span><span class="op">(</span><span class="va">signal_ptr</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">signal</span><span class="op">)</span>,</span>
<span><span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>, <span class="va">signal</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu"><a href="reference/ffi_fill_typed_buffer.html">ffi_fill_typed_buffer</a></span><span class="op">(</span><span class="va">kernel_ptr</span>, <span class="va">kernel</span>, <span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="fu"><a href="reference/ffi_copy_array.html">ffi_copy_array</a></span><span class="op">(</span><span class="va">kernel_ptr</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">kernel</span><span class="op">)</span>,</span>
<span><span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>, <span class="va">kernel</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span></span>
<span><span class="co"># Compile and load C convolution</span></span>
<span><span class="va">lib_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/dynamic_library_management.html">dll_compile_and_load</a></span><span class="op">(</span><span class="va">conv_code</span>, <span class="st">"bench_conv.so"</span>, cflags <span class="op">=</span> <span class="st">"-O3"</span><span class="op">)</span></span>
<span><span class="va">pointer_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_pointer.html">ffi_pointer</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">c_conv_fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/dll_ffi_symbol.html">dll_ffi_symbol</a></span><span class="op">(</span></span>
<span>  <span class="st">"c_convolve"</span>,</span>
<span>  <span class="fu"><a href="reference/ffi_void.html">ffi_void</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">pointer_t</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">pointer_t</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">pointer_t</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run C convolution via FFI</span></span>
<span><span class="fu">c_conv_fn</span><span class="op">(</span></span>
<span>      <span class="va">signal_ptr</span>, </span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">n_signal</span><span class="op">)</span>,</span>
<span>      <span class="va">kernel_ptr</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">n_kernel</span><span class="op">)</span>,</span>
<span>      <span class="va">out_ptr</span><span class="op">)</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="va">out_ptr</span></span>
<span><span class="co">#&gt; &lt;pointer: 0x5585a7ad1c00&gt;</span></span>
<span><span class="va">c_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_copy_array.html">ffi_copy_array</a></span><span class="op">(</span><span class="va">out_ptr</span>, <span class="va">n_out</span>, <span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run R convolution</span></span>
<span><span class="va">r_result</span> <span class="op">&lt;-</span> <span class="fu">slow_convolve</span><span class="op">(</span><span class="va">signal</span>, <span class="va">kernel</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="fu"><a href="reference/ffi_copy_array.html">ffi_copy_array</a></span><span class="op">(</span><span class="va">signal_ptr</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">signal</span><span class="op">)</span>,</span>
<span><span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>, <span class="va">signal</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="fu"><a href="reference/ffi_copy_array.html">ffi_copy_array</a></span><span class="op">(</span><span class="va">kernel_ptr</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">kernel</span><span class="op">)</span>,</span>
<span><span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>, <span class="va">kernel</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">c_result</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">r_result</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span></span>
<span><span class="fu"><a href="reference/ffi_copy_array.html">ffi_copy_array</a></span><span class="op">(</span><span class="va">out_ptr</span>, <span class="va">n_out</span>, <span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.21215265 0.46328129 0.17953895 0.05081738 0.57361490 0.88130298</span></span>
<span><span class="co"># Benchmark</span></span>
<span><span class="va">benchmark_result</span> <span class="op">&lt;-</span> <span class="fu">bench</span><span class="fu">::</span><span class="fu"><a href="https://bench.r-lib.org/reference/mark.html" class="external-link">mark</a></span><span class="op">(</span></span>
<span>  r <span class="op">=</span> <span class="fu">slow_convolve</span><span class="op">(</span><span class="va">signal</span>, <span class="va">kernel</span><span class="op">)</span>,</span>
<span>  c_ffi <span class="op">=</span> <span class="op">{</span></span>
<span>    <span class="fu">c_conv_fn</span><span class="op">(</span><span class="va">signal_ptr</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">n_signal</span><span class="op">)</span>, <span class="va">kernel_ptr</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">n_kernel</span><span class="op">)</span>, <span class="va">out_ptr</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="reference/ffi_copy_array.html">ffi_copy_array</a></span><span class="op">(</span><span class="va">out_ptr</span>, <span class="va">n_out</span>, <span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  check <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  iterations <span class="op">=</span> <span class="fl">20</span></span>
<span><span class="op">)</span></span>
<span><span class="va">benchmark_result</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 6</span></span>
<span><span class="co">#&gt;   expression      min   median `itr/sec` mem_alloc `gc/sec`</span></span>
<span><span class="co">#&gt;   &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 r            2.43ms   2.66ms      371.    78.2KB     19.5</span></span>
<span><span class="co">#&gt; 2 c_ffi      103.79µs 116.65µs     8032.    78.7KB      0</span></span>
<span></span>
<span><span class="fu"><a href="reference/dynamic_library_management.html">dll_unload</a></span><span class="op">(</span><span class="va">lib_path</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="dangerous-calling-r-api-exported-symbols">Dangerous: Calling R API Exported Symbols<a class="anchor" aria-label="anchor" href="#dangerous-calling-r-api-exported-symbols"></a>
</h2>
<p>Since <code>libR.so</code> is loaded we can use its exported symbols and functions. This allows calling R’s internal C API directly via FFI - the same functions that R packages use in their C code. This is for educational purposes only! Calling R internals incorrectly can crash R or corrupt memory.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Rf_ScalarInteger - create an R integer scalar (returns SEXP pointer)</span></span>
<span><span class="va">rf_ScalarInteger</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_function.html">ffi_function</a></span><span class="op">(</span><span class="st">"Rf_ScalarInteger"</span>, <span class="fu"><a href="reference/ffi_pointer.html">ffi_pointer</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rf_ScalarReal</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_function.html">ffi_function</a></span><span class="op">(</span><span class="st">"Rf_ScalarReal"</span>, <span class="fu"><a href="reference/ffi_pointer.html">ffi_pointer</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create R objects via C API</span></span>
<span><span class="va">int_sexp</span> <span class="op">&lt;-</span> <span class="fu">rf_ScalarInteger</span><span class="op">(</span><span class="fl">42L</span><span class="op">)</span></span>
<span><span class="va">dbl_sexp</span> <span class="op">&lt;-</span> <span class="fu">rf_ScalarReal</span><span class="op">(</span><span class="fl">3.14159</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract values using INTEGER_ELT / REAL_ELT</span></span>
<span><span class="va">rf_INTEGER_ELT</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_function.html">ffi_function</a></span><span class="op">(</span><span class="st">"INTEGER_ELT"</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_pointer.html">ffi_pointer</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_long.html">ffi_long</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rf_REAL_ELT</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_function.html">ffi_function</a></span><span class="op">(</span><span class="st">"REAL_ELT"</span>, <span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_pointer.html">ffi_pointer</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_long.html">ffi_long</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">rf_INTEGER_ELT</span><span class="op">(</span><span class="va">int_sexp</span>, <span class="fl">0L</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 42</span></span>
<span><span class="fu">rf_REAL_ELT</span><span class="op">(</span><span class="va">dbl_sexp</span>, <span class="fl">0L</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3.14159</span></span></code></pre></div>
<p>We can also create and extract strings:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Rf_mkString creates a STRSXP (character vector)</span></span>
<span><span class="va">rf_mkString</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_function.html">ffi_function</a></span><span class="op">(</span><span class="st">"Rf_mkString"</span>, <span class="fu"><a href="reference/ffi_pointer.html">ffi_pointer</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_string.html">ffi_string</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rf_STRING_ELT</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_function.html">ffi_function</a></span><span class="op">(</span><span class="st">"STRING_ELT"</span>, <span class="fu"><a href="reference/ffi_pointer.html">ffi_pointer</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_pointer.html">ffi_pointer</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_long.html">ffi_long</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rf_R_CHAR</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_function.html">ffi_function</a></span><span class="op">(</span><span class="st">"R_CHAR"</span>, <span class="fu"><a href="reference/ffi_string.html">ffi_string</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_pointer.html">ffi_pointer</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">str_sexp</span> <span class="op">&lt;-</span> <span class="fu">rf_mkString</span><span class="op">(</span><span class="st">"Hello from C!"</span><span class="op">)</span></span>
<span><span class="va">char_sexp</span> <span class="op">&lt;-</span> <span class="fu">rf_STRING_ELT</span><span class="op">(</span><span class="va">str_sexp</span>, <span class="fl">0L</span><span class="op">)</span></span>
<span><span class="fu">rf_R_CHAR</span><span class="op">(</span><span class="va">char_sexp</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Hello from C!"</span></span></code></pre></div>
<p>We can also read global variables from shared libraries using <code><a href="reference/ffi_deref_pointer.html">ffi_deref_pointer()</a></code> and <code><a href="reference/ffi_read_global.html">ffi_read_global()</a></code>:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Read global variables from our test library</span></span>
<span><span class="va">int_addr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/getNativeSymbolInfo.html" class="external-link">getNativeSymbolInfo</a></span><span class="op">(</span><span class="st">"test_global_int"</span>, <span class="st">"RSimpleFFI"</span><span class="op">)</span><span class="op">$</span><span class="va">address</span></span>
<span><span class="fu"><a href="reference/ffi_read_global.html">ffi_read_global</a></span><span class="op">(</span><span class="va">int_addr</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 42</span></span>
<span></span>
<span><span class="va">dbl_addr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/getNativeSymbolInfo.html" class="external-link">getNativeSymbolInfo</a></span><span class="op">(</span><span class="st">"test_global_double"</span>, <span class="st">"RSimpleFFI"</span><span class="op">)</span><span class="op">$</span><span class="va">address</span></span>
<span><span class="fu"><a href="reference/ffi_read_global.html">ffi_read_global</a></span><span class="op">(</span><span class="va">dbl_addr</span>, <span class="fu"><a href="reference/ffi_double.html">ffi_double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3.14159</span></span>
<span></span>
<span><span class="co"># For pointer globals, use ffi_deref_pointer</span></span>
<span><span class="va">str_ptr_addr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/getNativeSymbolInfo.html" class="external-link">getNativeSymbolInfo</a></span><span class="op">(</span><span class="st">"test_global_string"</span>, <span class="st">"RSimpleFFI"</span><span class="op">)</span><span class="op">$</span><span class="va">address</span></span>
<span><span class="fu"><a href="reference/pointer_to_string.html">pointer_to_string</a></span><span class="op">(</span><span class="fu"><a href="reference/ffi_deref_pointer.html">ffi_deref_pointer</a></span><span class="op">(</span><span class="va">str_ptr_addr</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Hello from global!"</span></span></code></pre></div>
<p>Now let’s call R functions entirely through the C API:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get R_GlobalEnv - it's a global pointer variable</span></span>
<span><span class="va">R_GlobalEnv</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_deref_pointer.html">ffi_deref_pointer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getNativeSymbolInfo.html" class="external-link">getNativeSymbolInfo</a></span><span class="op">(</span><span class="st">"R_GlobalEnv"</span><span class="op">)</span><span class="op">$</span><span class="va">address</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define R API functions</span></span>
<span><span class="va">rf_install</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_function.html">ffi_function</a></span><span class="op">(</span><span class="st">"Rf_install"</span>, <span class="fu"><a href="reference/ffi_pointer.html">ffi_pointer</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_string.html">ffi_string</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rf_lang1</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_function.html">ffi_function</a></span><span class="op">(</span><span class="st">"Rf_lang1"</span>, <span class="fu"><a href="reference/ffi_pointer.html">ffi_pointer</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_pointer.html">ffi_pointer</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rf_lang2</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_function.html">ffi_function</a></span><span class="op">(</span><span class="st">"Rf_lang2"</span>, <span class="fu"><a href="reference/ffi_pointer.html">ffi_pointer</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_pointer.html">ffi_pointer</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_pointer.html">ffi_pointer</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rf_eval</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_function.html">ffi_function</a></span><span class="op">(</span><span class="st">"Rf_eval"</span>, <span class="fu"><a href="reference/ffi_pointer.html">ffi_pointer</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_pointer.html">ffi_pointer</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_pointer.html">ffi_pointer</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Call Sys.time() entirely via R's C API!</span></span>
<span><span class="va">sys_time_sym</span> <span class="op">&lt;-</span> <span class="fu">rf_install</span><span class="op">(</span><span class="st">"Sys.time"</span><span class="op">)</span></span>
<span><span class="va">call_expr</span> <span class="op">&lt;-</span> <span class="fu">rf_lang1</span><span class="op">(</span><span class="va">sys_time_sym</span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">rf_eval</span><span class="op">(</span><span class="va">call_expr</span>, <span class="va">R_GlobalEnv</span><span class="op">)</span></span>
<span><span class="fu">rf_REAL_ELT</span><span class="op">(</span><span class="va">result</span>, <span class="fl">0L</span><span class="op">)</span>  <span class="co"># Unix timestamp</span></span>
<span><span class="co">#&gt; [1] 1764796888</span></span>
<span></span>
<span><span class="co"># Call abs(-42) via C API</span></span>
<span><span class="va">abs_sym</span> <span class="op">&lt;-</span> <span class="fu">rf_install</span><span class="op">(</span><span class="st">"abs"</span><span class="op">)</span></span>
<span><span class="va">neg_val</span> <span class="op">&lt;-</span> <span class="fu">rf_ScalarInteger</span><span class="op">(</span><span class="op">-</span><span class="fl">42L</span><span class="op">)</span></span>
<span><span class="va">abs_call</span> <span class="op">&lt;-</span> <span class="fu">rf_lang2</span><span class="op">(</span><span class="va">abs_sym</span>, <span class="va">neg_val</span><span class="op">)</span></span>
<span><span class="va">abs_result</span> <span class="op">&lt;-</span> <span class="fu">rf_eval</span><span class="op">(</span><span class="va">abs_call</span>, <span class="va">R_GlobalEnv</span><span class="op">)</span></span>
<span><span class="fu">rf_INTEGER_ELT</span><span class="op">(</span><span class="va">abs_result</span>, <span class="fl">0L</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 42</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="header-parsing-and-code-generation">Header Parsing and Code Generation<a class="anchor" aria-label="anchor" href="#header-parsing-and-code-generation"></a>
</h2>
<p>RSimpleFFI can parse C header files using <a href="https://github.com/tinycc/tinycc" class="external-link">tinycc</a> and automatically generate R bindings, making it easy to create R packages that wrap C libraries.</p>
<div class="section level3">
<h3 id="parse-headers">Parse Headers<a class="anchor" aria-label="anchor" href="#parse-headers"></a>
</h3>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Parse a C header file using tinycc preprocessor</span></span>
<span><span class="va">header_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"simple_types.h"</span>, package <span class="op">=</span> <span class="st">"RSimpleFFI"</span><span class="op">)</span></span>
<span><span class="va">parsed</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_parse_header.html">ffi_parse_header</a></span><span class="op">(</span><span class="va">header_file</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Inspect what was found</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">parsed</span><span class="op">$</span><span class="va">defines</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "SIMPLE_TYPES_H" "MAX_BUFFER"     "MIN_SIZE"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">parsed</span><span class="op">$</span><span class="va">structs</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Point"</span></span>
<span><span class="va">parsed</span><span class="op">$</span><span class="va">functions</span><span class="op">$</span><span class="va">name</span></span>
<span><span class="co">#&gt; [1] "add"           "multiply"      "process_point"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="generate-r-bindings">Generate R Bindings<a class="anchor" aria-label="anchor" href="#generate-r-bindings"></a>
</h3>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate complete R code</span></span>
<span><span class="va">code</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/generate_r_bindings.html">generate_r_bindings</a></span><span class="op">(</span><span class="va">parsed</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Preview first part of generated code</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">code</span>, <span class="fl">1</span>, <span class="fl">500</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "# Auto-generated R bindings for simple_types.h\n# Generated on: 2025-12-03 22:21:27.995608\n#\n# NOTE: These functions expect symbols to be available in the current process.\n# For external libraries, load them first with dll_load() or use dll_ffi_symbol().\n#\n# Type handling:\n#  - Primitives (int, double, etc.): passed by value, auto-converted\n#  - char*: use ffi_string(), automatically converts to/from R character\n#  - struct Foo*: use ffi_pointer(), allocate with ffi_struct() + ffi_alloc()\n#  - St"</span></span>
<span></span>
<span><span class="co"># The generated code includes:</span></span>
<span><span class="co"># - Constants from #define</span></span>
<span><span class="co"># - ffi_struct() definitions for structs</span></span>
<span><span class="co"># - Wrapper functions with roxygen2 documentation</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="source-generated-code">Source Generated Code<a class="anchor" aria-label="anchor" href="#source-generated-code"></a>
</h3>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Write to temp file and source it</span></span>
<span><span class="va">tmpfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".R"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span><span class="va">code</span>, <span class="va">tmpfile</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Source the generated bindings</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="va">tmpfile</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Now we can use the generated constants and structs</span></span>
<span><span class="va">MAX_BUFFER</span></span>
<span><span class="co">#&gt; [1] 1024</span></span>
<span><span class="va">MIN_SIZE</span></span>
<span><span class="co">#&gt; [1] 16</span></span>
<span></span>
<span><span class="co"># The Point struct is now available</span></span>
<span><span class="va">Point</span></span>
<span><span class="co">#&gt; StructType(fields=[x, y], size=8)</span></span>
<span><span class="co">#&gt; Fields:</span></span>
<span><span class="co">#&gt;   x: FFIType(int, size=4)</span></span>
<span><span class="co">#&gt;   y: FFIType(int, size=4)</span></span>
<span></span>
<span><span class="co"># Clean up</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink</a></span><span class="op">(</span><span class="va">tmpfile</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="generate-bindings-for-system-libraries">Generate Bindings for System Libraries<a class="anchor" aria-label="anchor" href="#generate-bindings-for-system-libraries"></a>
</h3>
<p>Let’s create bindings for real C library functions:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a simple header with libc function signatures</span></span>
<span><span class="va">libc_header</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".h"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"// String functions"</span>, </span>
<span>  <span class="st">"unsigned long strlen(const char* s);"</span>,</span>
<span>  <span class="st">"int strcmp(const char* s1, const char* s2);"</span>,</span>
<span>  <span class="st">""</span>,</span>
<span>  <span class="st">"// Math functions"</span>,</span>
<span>  <span class="st">"int abs(int n);"</span></span>
<span><span class="op">)</span>, <span class="va">libc_header</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Parse and generate bindings</span></span>
<span><span class="va">libc_parsed</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_parse_header.html">ffi_parse_header</a></span><span class="op">(</span><span class="va">libc_header</span><span class="op">)</span></span>
<span><span class="va">libc_code</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/generate_r_bindings.html">generate_r_bindings</a></span><span class="op">(</span><span class="va">libc_parsed</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Preview generated code</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">libc_code</span>, <span class="fl">1</span>, <span class="fl">600</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # Auto-generated R bindings for file2a5254fa35442.h</span></span>
<span><span class="co">#&gt; # Generated on: 2025-12-03 22:21:28.017646</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # NOTE: These functions expect symbols to be available in the current process.</span></span>
<span><span class="co">#&gt; # For external libraries, load them first with dll_load() or use dll_ffi_symbol().</span></span>
<span><span class="co">#&gt; #</span></span>
<span><span class="co">#&gt; # Type handling:</span></span>
<span><span class="co">#&gt; #  - Primitives (int, double, etc.): passed by value, auto-converted</span></span>
<span><span class="co">#&gt; #  - char*: use ffi_string(), automatically converts to/from R character</span></span>
<span><span class="co">#&gt; #  - struct Foo*: use ffi_pointer(), allocate with ffi_struct() + ffi_alloc()</span></span>
<span><span class="co">#&gt; #  - Struct fields: access with ffi_get_field() and ffi_set_field()</span></span>
<span><span class="co">#&gt; #  - Union fields: same as structs</span></span>
<span></span>
<span><span class="co"># Source the bindings</span></span>
<span><span class="va">tmpfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".R"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span><span class="va">libc_code</span>, <span class="va">tmpfile</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="va">tmpfile</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load libc</span></span>
<span><span class="va">libc_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/dynamic_library_management.html">dll_load_system</a></span><span class="op">(</span><span class="st">"libc.so.6"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading system library from: /usr/lib/x86_64-linux-gnu/libc.so.6</span></span>
<span></span>
<span><span class="co"># Use generated wrapper functions!</span></span>
<span><span class="fu">r_strlen</span><span class="op">(</span><span class="st">"Hello, World!"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 13</span></span>
<span></span>
<span><span class="fu">r_strcmp</span><span class="op">(</span><span class="st">"apple"</span>, <span class="st">"banana"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -1</span></span>
<span></span>
<span><span class="fu">r_strcmp</span><span class="op">(</span><span class="st">"test"</span>, <span class="st">"test"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span></span>
<span><span class="fu">r_abs</span><span class="op">(</span><span class="op">-</span><span class="fl">42L</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 42</span></span>
<span></span>
<span><span class="fu"><a href="reference/dynamic_library_management.html">dll_unload</a></span><span class="op">(</span><span class="va">libc_path</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unlink.html" class="external-link">unlink</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">tmpfile</span>, <span class="va">libc_header</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="create-r-packages">Create R Packages<a class="anchor" aria-label="anchor" href="#create-r-packages"></a>
</h3>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate complete package scaffolding</span></span>
<span><span class="va">tmpdir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">tmpdir</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="reference/generate_package_from_headers.html">generate_package_from_headers</a></span><span class="op">(</span></span>
<span>  header_files <span class="op">=</span> <span class="va">header_file</span>,</span>
<span>  package_name <span class="op">=</span> <span class="st">"MyRPackage"</span>,</span>
<span>  library_name <span class="op">=</span> <span class="st">"mylib"</span>,</span>
<span>  output_dir <span class="op">=</span> <span class="va">tmpdir</span>,</span>
<span>  use_system_lib <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  authors_r <span class="op">=</span> <span class="st">'person("John", "Doe", email = "john@example.com", role = c("aut", "cre"))'</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check what was created - proper R package structure</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">tmpdir</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "DESCRIPTION" "LICENSE"     "NAMESPACE"   "R"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">tmpdir</span>, <span class="st">"R"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "helpers.R"               "simple_types_bindings.R"</span></span>
<span><span class="co">#&gt; [3] "zzz.R"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="helper-functions">Helper Functions<a class="anchor" aria-label="anchor" href="#helper-functions"></a>
</h3>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Convert struct to/from R lists</span></span>
<span><span class="va">Point</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_struct.html">ffi_struct</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pt</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_struct_from_list.html">ffi_struct_from_list</a></span><span class="op">(</span><span class="va">Point</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">10L</span>, y <span class="op">=</span> <span class="fl">20L</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">values</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_struct_to_list.html">ffi_struct_to_list</a></span><span class="op">(</span><span class="va">pt</span>, <span class="va">Point</span><span class="op">)</span></span>
<span><span class="va">values</span></span>
<span><span class="co">#&gt; $x</span></span>
<span><span class="co">#&gt; [1] 10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $y</span></span>
<span><span class="co">#&gt; [1] 20</span></span>
<span></span>
<span><span class="co"># Create arrays of structs</span></span>
<span><span class="va">points</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_struct_array_from_list.html">ffi_struct_array_from_list</a></span><span class="op">(</span><span class="va">Point</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">0L</span>, y <span class="op">=</span> <span class="fl">0L</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">10L</span>, y <span class="op">=</span> <span class="fl">20L</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Pretty print structs</span></span>
<span><span class="fu"><a href="reference/ffi_print_struct.html">ffi_print_struct</a></span><span class="op">(</span><span class="va">pt</span>, <span class="va">Point</span><span class="op">)</span></span>
<span><span class="co">#&gt; Struct (struct):</span></span>
<span><span class="co">#&gt;   x (int): 10 </span></span>
<span><span class="co">#&gt;   y (int): 20</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="limitations">Limitations<a class="anchor" aria-label="anchor" href="#limitations"></a>
</h2>
<p>Current limitations include unnecessary copying, lack of protection, potential memory leaks, and type objects are C pointers that are never finalized.</p>
<div class="section level3">
<h3 id="bit-fields">Bit-fields<a class="anchor" aria-label="anchor" href="#bit-fields"></a>
</h3>
<p>Bit-field structs are laid out by the compiler as compact integers. While they are structs in C, <code><a href="reference/ffi_struct.html">ffi_struct()</a></code> models each field as a separate full-sized type, mismatching the actual memory layout.</p>
<p>Example:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span> <span class="dt">unsigned</span> enabled<span class="op">:</span><span class="dv">1</span><span class="op">;</span> mode<span class="op">:</span><span class="dv">3</span><span class="op">;</span> priority<span class="op">:</span><span class="dv">4</span><span class="op">;</span> reserved<span class="op">:</span><span class="dv">24</span><span class="op">;</span> <span class="op">}</span> SettingsFlags<span class="op">;</span></span>
<span id="cb43-2"><a href="#cb43-2" tabindex="-1"></a><span class="dt">int</span> get_mode<span class="op">(</span>SettingsFlags settings<span class="op">);</span></span>
<span id="cb43-3"><a href="#cb43-3" tabindex="-1"></a>SettingsFlags increment<span class="op">(</span>SettingsFlags settings<span class="op">);</span></span></code></pre></div>
<p>Modeling with <code>ffi_struct(enabled=ffi_int(), mode=ffi_int(), ...)</code> creates a 16-byte struct (4 fields × 4 bytes), but the C compiler packs <code>SettingsFlags</code> into 4 bytes (32 bits total).</p>
<p>Model bit-field structs as their packed integer type. Sum bit widths (1+3+4+24 = 32 bits) and use the corresponding <code>ffi_uintN()</code> type (<code><a href="reference/ffi_uint32.html">ffi_uint32()</a></code> here).</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># C functions that take/return SettingsFlags (32-bit bit-field struct)</span></span>
<span><span class="co"># Model the struct as uint32_t in the FFI signature</span></span>
<span></span>
<span><span class="co"># Create a packed value (enabled=1, mode=5, priority=10)</span></span>
<span><span class="va">pack_fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_function.html">ffi_function</a></span><span class="op">(</span><span class="st">"test_bitfield_pack"</span>, <span class="fu"><a href="reference/ffi_uint32.html">ffi_uint32</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">packed</span> <span class="op">&lt;-</span> <span class="fu">pack_fn</span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">5L</span>, <span class="fl">10L</span><span class="op">)</span></span>
<span><span class="va">packed</span></span>
<span><span class="co">#&gt; [1] 171</span></span>
<span></span>
<span><span class="co"># Pass bit-field struct by value (as uint32_t)</span></span>
<span><span class="va">get_mode_fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_function.html">ffi_function</a></span><span class="op">(</span><span class="st">"test_bitfield_struct_get_mode"</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_uint32.html">ffi_uint32</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">get_mode_fn</span><span class="op">(</span><span class="va">packed</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 5</span></span>
<span></span>
<span><span class="co"># Return bit-field struct by value (as uint32_t)</span></span>
<span><span class="va">increment_fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_function.html">ffi_function</a></span><span class="op">(</span><span class="st">"test_bitfield_struct_increment_priority"</span>, <span class="fu"><a href="reference/ffi_uint32.html">ffi_uint32</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_uint32.html">ffi_uint32</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">incremented</span> <span class="op">&lt;-</span> <span class="fu">increment_fn</span><span class="op">(</span><span class="va">packed</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Verify the change</span></span>
<span><span class="va">get_priority_fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_function.html">ffi_function</a></span><span class="op">(</span><span class="st">"test_bitfield_get_priority"</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_uint32.html">ffi_uint32</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">get_priority_fn</span><span class="op">(</span><span class="va">packed</span><span class="op">)</span>      <span class="co"># Original: 10</span></span>
<span><span class="co">#&gt; [1] 10</span></span>
<span><span class="fu">get_priority_fn</span><span class="op">(</span><span class="va">incremented</span><span class="op">)</span> <span class="co"># After increment: 11</span></span>
<span><span class="co">#&gt; [1] 11</span></span></code></pre></div>
<p>Bit-field structs passed by pointer:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># C functions that take SettingsFlags* (pointer to bit-field struct)</span></span>
<span></span>
<span><span class="co"># Allocate buffer for 32-bit bit-field struct</span></span>
<span><span class="va">buf</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/alloc.html">ffi_alloc</a></span><span class="op">(</span><span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>, <span class="fl">1L</span><span class="op">)</span>  <span class="co"># uint32_t and int are same size</span></span>
<span><span class="va">pack_fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_function.html">ffi_function</a></span><span class="op">(</span><span class="st">"test_bitfield_pack"</span>, <span class="fu"><a href="reference/ffi_uint32.html">ffi_uint32</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">packed</span> <span class="op">&lt;-</span> <span class="fu">pack_fn</span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">3L</span>, <span class="fl">7L</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/ffi_fill_typed_buffer.html">ffi_fill_typed_buffer</a></span><span class="op">(</span><span class="va">buf</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">packed</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span></span>
<span><span class="co"># Read field via pointer to struct</span></span>
<span><span class="va">ptr_get_fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_function.html">ffi_function</a></span><span class="op">(</span><span class="st">"test_bitfield_struct_ptr_get_mode"</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_pointer.html">ffi_pointer</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">ptr_get_fn</span><span class="op">(</span><span class="va">buf</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span></span>
<span><span class="co"># Modify field via pointer to struct</span></span>
<span><span class="va">ptr_set_fn</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_function.html">ffi_function</a></span><span class="op">(</span><span class="st">"test_bitfield_struct_ptr_set_mode"</span>, <span class="fu"><a href="reference/ffi_void.html">ffi_void</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_pointer.html">ffi_pointer</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="reference/ffi_int.html">ffi_int</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">ptr_set_fn</span><span class="op">(</span><span class="va">buf</span>, <span class="fl">5L</span><span class="op">)</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="fu">ptr_get_fn</span><span class="op">(</span><span class="va">buf</span><span class="op">)</span>  <span class="co"># Verify: now 5</span></span>
<span><span class="co">#&gt; [1] 5</span></span></code></pre></div>
<p>For convenient access, use bitfield helpers:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">settings</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_create_bitfield_accessors.html">ffi_create_bitfield_accessors</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="fl">1L</span>, mode <span class="op">=</span> <span class="fl">3L</span>, priority <span class="op">=</span> <span class="fl">4L</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">packed</span> <span class="op">&lt;-</span> <span class="va">settings</span><span class="op">$</span><span class="fu">pack</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>enabled <span class="op">=</span> <span class="fl">1L</span>, mode <span class="op">=</span> <span class="fl">5L</span>, priority <span class="op">=</span> <span class="fl">10L</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">settings</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="va">packed</span>, <span class="st">"mode"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 5</span></span>
<span><span class="va">settings</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="va">packed</span>, <span class="st">"priority"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 10</span></span></code></pre></div>
<p>Helper functions: <code><a href="reference/ffi_pack_bits.html">ffi_pack_bits()</a></code>, <code><a href="reference/ffi_unpack_bits.html">ffi_unpack_bits()</a></code>, <code><a href="reference/ffi_extract_bit_field.html">ffi_extract_bit_field()</a></code>, <code><a href="reference/ffi_set_bit_field.html">ffi_set_bit_field()</a></code>, <code><a href="reference/ffi_create_bitfield_accessors.html">ffi_create_bitfield_accessors()</a></code>.</p>
</div>
<div class="section level3">
<h3 id="id_64-bit-bitfields">64-bit Bitfields<a class="anchor" aria-label="anchor" href="#id_64-bit-bitfields"></a>
</h3>
<p>For bitfields exceeding 32 bits or requiring full 64-bit range, use the 64-bit variants:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Pack fields totaling more than 32 bits</span></span>
<span><span class="va">packed64</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_pack_bits64.html">ffi_pack_bits64</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">0x7FFFFFFFL</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">31L</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">packed64</span></span>
<span><span class="co">#&gt; [1] 4294967295</span></span>
<span></span>
<span><span class="co"># Extract fields</span></span>
<span><span class="fu"><a href="reference/ffi_unpack_bits64.html">ffi_unpack_bits64</a></span><span class="op">(</span><span class="va">packed64</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">31L</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]          1 2147483647</span></span>
<span></span>
<span><span class="co"># Single field extraction</span></span>
<span><span class="fu"><a href="reference/ffi_extract_bits64.html">ffi_extract_bits64</a></span><span class="op">(</span><span class="va">packed64</span>, <span class="fl">0L</span>, <span class="fl">1L</span><span class="op">)</span>   <span class="co"># First field</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="fu"><a href="reference/ffi_extract_bits64.html">ffi_extract_bits64</a></span><span class="op">(</span><span class="va">packed64</span>, <span class="fl">1L</span>, <span class="fl">31L</span><span class="op">)</span>  <span class="co"># Second field</span></span>
<span><span class="co">#&gt; [1] 2147483647</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="signed-bitfields">Signed Bitfields<a class="anchor" aria-label="anchor" href="#signed-bitfields"></a>
</h3>
<p>For signed integer fields (common in hardware registers), use signed extraction:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Pack value 13 (0xD) which represents -3 in signed 4-bit</span></span>
<span><span class="va">packed</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/ffi_pack_bits.html">ffi_pack_bits</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">13L</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4L</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Unsigned extraction returns 13</span></span>
<span><span class="fu"><a href="reference/ffi_extract_bit_field.html">ffi_extract_bit_field</a></span><span class="op">(</span><span class="va">packed</span>, <span class="fl">0L</span>, <span class="fl">4L</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 13</span></span>
<span></span>
<span><span class="co"># Signed extraction returns -3 (sign-extended)</span></span>
<span><span class="fu"><a href="reference/ffi_extract_signed_bit_field.html">ffi_extract_signed_bit_field</a></span><span class="op">(</span><span class="va">packed</span>, <span class="fl">0L</span>, <span class="fl">4L</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -3</span></span>
<span></span>
<span><span class="co"># 64-bit signed extraction also available</span></span>
<span><span class="fu"><a href="reference/ffi_extract_signed_bits64.html">ffi_extract_signed_bits64</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">as.double</a></span><span class="op">(</span><span class="va">packed</span><span class="op">)</span>, <span class="fl">0L</span>, <span class="fl">4L</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] -3</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="structs--unions-by-value">Structs &amp; Unions By Value<a class="anchor" aria-label="anchor" href="#structs--unions-by-value"></a>
</h3>
<p>Struct/union passing by value may be unreliable across platforms. Packed structs cannot be passed by value (libffi limitation). Prefer pointers.</p>
</div>
</div>
<div class="section level2">
<h2 id="license">License<a class="anchor" aria-label="anchor" href="#license"></a>
</h2>
<p>This project is licensed under the GPL-3 License.</p>
</div>
</div>
<div class="section level1">
<h1 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h1>
<ul>
<li><p><a href="https://github.com/omegahat/Rffi" class="external-link">Rffi</a></p></li>
<li><p><a href="https://github.com/libffi/libffi" class="external-link">libffi</a> - Portable foreign function interface library</p></li>
<li><p><a href="https://github.com/tinycc/tinycc" class="external-link">tinycc</a> - Tiny C Compiler used for header parsing</p></li>
<li><p><a href="http://www.chiark.greenend.org.uk/doc/libffi-dev/html/Using-libffi.html" class="external-link">libffi Examples</a></p></li>
<li><p><a href="https://docs.python.org/3/library/ctypes.html" class="external-link">CPython’s ctypes module</a></p></li>
<li><p>[purectypes repo] <a href="https://github.com/aguinet/purectypes.git" class="external-link uri">https://github.com/aguinet/purectypes.git</a></p></li>
</ul>
</div>

  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/sounkou-bioinfo/RSimpleFFI/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/sounkou-bioinfo/RSimpleFFI/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="https://www.r-project.org/Licenses/GPL-3" class="external-link">GPL-3</a></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing RSimpleFFI</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Sounkou Mahamane Toure <br><small class="roles"> Author, maintainer </small>   </li>
<li><a href="authors.html">More about authors...</a></li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/sounkou-bioinfo/RSimpleFFI/actions/workflows/R-CMD-check.yaml" class="external-link"><img src="https://github.com/sounkou-bioinfo/RSimpleFFI/actions/workflows/R-CMD-check.yaml/badge.svg" alt="R-CMD-check"></a></li>
<li><a href="https://sounkou-bioinfo.r-universe.dev/RSimpleFFI" class="external-link"><img src="https://sounkou-bioinfo.r-universe.dev/RSimpleFFI/badges/version" alt="RSimpleFFI status badge"></a></li>
</ul>
</div>

  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sounkou Mahamane Toure.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
